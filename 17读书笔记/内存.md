# 内存

## 内存分析

### 影响性能的内存问题
* 内存泄漏，如页面性能随着时间的延长越来越差
* 内存膨胀，页面的性能一直很糟糕
* 频繁GC，页面出现延迟或经常暂停（脚本执行暂停）

### 分析方法
* Chrome「任务管理器」实时的查看内存使用量（可以观测内存膨胀，频繁GC）
  * Memory，内存占用空间，表示原生内存。DOM节点存储在原生内存中，如果值正在增大，表名正在创建DOM节点
  * JavaScript Memory，JavaScript使用的内存，表示JS堆。如果值正在增大，要么正在创建新对象，要么现有对象正在增长
* Chrome Timeline 记录一段时间内的内存使用情况（可以观测内存泄漏，频繁GC）
  * JS Heap
  * Documents
  * Nodes
  * Listeners
  * GPU Memory
* Chrome 堆快照（可观测内存泄漏，可以确定「已分离」节点的GC情况）
* Chrome 分配时间线
* Chrome 按函数调查内存分配

## 场景一（内存膨胀）
页面上包含大量高质量图片缩略图，在低端设备上页面卡顿或崩溃

### 原因
* 浏览器处理图片时，如果图片不在可视区域内，浏览器会自动释放不可见图片的部分内存，而当所有图片都在可视区域内（如大量的大图缩略图），浏览器短时间内需要大量的内存空间供图片展示使用，当内存不足时就容易产生卡顿或直接崩溃，在低端机型上表现更为明显。
* webview向native申请内存时，内存不足时系统会释放部分内存供使用，但是无法释放内存或释放的内存不足时，webview页面会被系统释放导致页面崩溃。在android中的webview与ios中的wkviewview下，由于webview是独立进程，所以webview崩溃后，app依然可用，但是当ios是uiwebview时，与app共享进程，会使整个app崩溃

### 解决方案
* 图片压缩
* 图片质量监测？

### 其它可能场景
* 调用摄像头拍照，图片未压缩生成的缩略图
* 运营后台上传的缩略图质量过高，未压缩

## 场景二（内存泄露）
大量dom引用未释放（分离的DOM树），大量事件注册未取消，在单页应用中尤其常见

### 原因
* DOM节点从DOM树中移除，但是在JavaScript里仍然被引用，导致无法GC
* DOM节点注册了事件，但是页面卸载时未取消事件，导致无法GC

### 解决方案
* 使用 堆快照 进行分析，找到「已分离」的DOM，具体问题具体分析
* 养成良好的编写DOM取消事件注册习惯